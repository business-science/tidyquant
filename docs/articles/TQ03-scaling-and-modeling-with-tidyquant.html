<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scaling and Modeling with tidyquant • tidyquant</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Scaling and Modeling with tidyquant">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-76139189-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-76139189-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidyquant</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../reference/index.html">Function Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/TQ06-excel-in-r.html">NEW: Excel in R</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Financial Workflow</li>
    <li>
      <a href="../articles/TQ00-introduction-to-tidyquant.html">Introduction to tidyquant</a>
    </li>
    <li>
      <a href="../articles/TQ01-core-functions-in-tidyquant.html">Core functions</a>
    </li>
    <li>
      <a href="../articles/TQ02-quant-integrations-in-tidyquant.html">Quantitative integrations</a>
    </li>
    <li>
      <a href="../articles/TQ03-scaling-and-modeling-with-tidyquant.html">Scaling and modeling</a>
    </li>
    <li>
      <a href="../articles/TQ04-charting-with-tidyquant.html">Charting</a>
    </li>
    <li>
      <a href="../articles/TQ05-performance-analysis-with-tidyquant.html">Performance analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/business-science/tidyquant">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Scaling and Modeling with tidyquant</h1>
                        <h4 class="author">Matt Dancho</h4>
            
            <h4 class="date">2020-03-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/business-science/tidyquant/blob/master/vignettes/TQ03-scaling-and-modeling-with-tidyquant.Rmd"><code>vignettes/TQ03-scaling-and-modeling-with-tidyquant.Rmd</code></a></small>
      <div class="hidden name"><code>TQ03-scaling-and-modeling-with-tidyquant.Rmd</code></div>

    </div>

    
    
<blockquote>
<p>Designed for the data science workflow of the <code>tidyverse</code></p>
</blockquote>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>The greatest benefit to <code>tidyquant</code> is the ability to apply the data science workflow to easily model and scale your financial analysis as described in <a href="http://r4ds.had.co.nz/"><em>R for Data Science</em></a>. Scaling is the process of creating an analysis for one asset and then extending it to multiple groups. This idea of scaling is incredibly useful to financial analysts because typically one wants to compare many assets to make informed decisions. Fortunately, the <code>tidyquant</code> package integrates with the <code>tidyverse</code> making scaling super simple!</p>
<p>All <code>tidyquant</code> functions return data in the <code>tibble</code> (tidy data frame) format, which allows for interaction within the <code>tidyverse</code>. This means we can:</p>
<ul>
<li>Seamlessly scale data retrieval and mutations</li>
<li>Use the pipe (<code><a href="../reference/pipe.html">%&gt;%</a></code>) for chaining operations</li>
<li>Use <code>dplyr</code> and <code>tidyr</code>: <code>select</code>, <code>filter</code>, <code>group_by</code>, <code>nest</code>/<code>unnest</code>, <code>spread</code>/<code>gather</code>, etc</li>
<li>Use <code>purrr</code>: mapping functions with <code>map</code>
</li>
<li>Model financial analysis using the data science workflow in <a href="http://r4ds.had.co.nz/"><em>R for Data Science</em></a>
</li>
</ul>
<p>We’ll go through some useful techniques for getting and manipulating groups of data.</p>
</div>
<div id="prerequisites" class="section level1">
<h1 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h1>
<p>Load the <code>tidyquant</code> package to get started.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># Loads tidyquant, lubridate, xts, quantmod, TTR, and PerformanceAnalytics</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyquant)  </a></code></pre></div>
</div>
<div id="scaling-the-getting-of-financial-data" class="section level1">
<h1 class="hasAnchor">
<a href="#scaling-the-getting-of-financial-data" class="anchor"></a>1.0 Scaling the Getting of Financial Data</h1>
<p>A very basic example is retrieving the stock prices for multiple stocks. There are three primary ways to do this:</p>
<div id="method-1-map-a-character-vector-with-multiple-stock-symbols" class="section level2">
<h2 class="hasAnchor">
<a href="#method-1-map-a-character-vector-with-multiple-stock-symbols" class="anchor"></a>Method 1: Map a character vector with multiple stock symbols</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AAPL"</span>, <span class="st">"GOOG"</span>, <span class="st">"FB"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/tq_get.html">tq_get</a></span>(<span class="dt">get =</span> <span class="st">"stock.prices"</span>, <span class="dt">from =</span> <span class="st">"2016-01-01"</span>, <span class="dt">to =</span> <span class="st">"2017-01-01"</span>)</a></code></pre></div>
<pre><code>## # A tibble: 756 x 8
##    symbol date        open  high   low close   volume adjusted
##    &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 AAPL   2016-01-04 103.  105.  102   105.  67649400     98.2
##  2 AAPL   2016-01-05 106.  106.  102.  103.  55791000     95.8
##  3 AAPL   2016-01-06 101.  102.   99.9 101.  68457400     93.9
##  4 AAPL   2016-01-07  98.7 100.   96.4  96.4 81094400     89.9
##  5 AAPL   2016-01-08  98.6  99.1  96.8  97.0 70798000     90.4
##  6 AAPL   2016-01-11  99.0  99.1  97.3  98.5 49739400     91.9
##  7 AAPL   2016-01-12 101.  101.   98.8 100.  49154200     93.2
##  8 AAPL   2016-01-13 100.  101.   97.3  97.4 62439600     90.8
##  9 AAPL   2016-01-14  98.0 100.   95.7  99.5 63170100     92.8
## 10 AAPL   2016-01-15  96.2  97.7  95.4  97.1 79833900     90.6
## # … with 746 more rows</code></pre>
<p>The output is a single level tibble with all or the stock prices in one tibble. The auto-generated column name is “symbol”, which can be pre-emptively renamed by giving the vector a name (e.g. <code>stocks &lt;- c("AAPL", "GOOG", "FB")</code>) and then piping to <code>tq_get</code>.</p>
</div>
<div id="method-2-map-a-tibble-with-stocks-in-first-column" class="section level2">
<h2 class="hasAnchor">
<a href="#method-2-map-a-tibble-with-stocks-in-first-column" class="anchor"></a>Method 2: Map a tibble with stocks in first column</h2>
<p>First, get a stock list in data frame format either by making the tibble or retrieving from <code>tq_index</code> / <code>tq_exchange</code>. The stock symbols must be in the first column.</p>
<div id="method-2a-make-a-tibble" class="section level3">
<h3 class="hasAnchor">
<a href="#method-2a-make-a-tibble" class="anchor"></a>Method 2A: Make a tibble</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">stock_list &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">stocks =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AAPL"</span>, <span class="st">"JPM"</span>, <span class="st">"CVX"</span>),</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                     <span class="dt">industry =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Technology"</span>, <span class="st">"Financial"</span>, <span class="st">"Energy"</span>))</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">stock_list</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   stocks industry  
##   &lt;chr&gt;  &lt;chr&gt;     
## 1 AAPL   Technology
## 2 JPM    Financial 
## 3 CVX    Energy</code></pre>
<p>Second, send the stock list to <code>tq_get</code>. Notice how the symbol and industry columns are automatically expanded the length of the stock prices.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">stock_list <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/tq_get.html">tq_get</a></span>(<span class="dt">get =</span> <span class="st">"stock.prices"</span>, <span class="dt">from =</span> <span class="st">"2016-01-01"</span>, <span class="dt">to =</span> <span class="st">"2017-01-01"</span>)</a></code></pre></div>
<pre><code>## # A tibble: 756 x 9
##    stocks industry   date        open  high   low close   volume adjusted
##    &lt;chr&gt;  &lt;chr&gt;      &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 AAPL   Technology 2016-01-04 103.  105.  102   105.  67649400     98.2
##  2 AAPL   Technology 2016-01-05 106.  106.  102.  103.  55791000     95.8
##  3 AAPL   Technology 2016-01-06 101.  102.   99.9 101.  68457400     93.9
##  4 AAPL   Technology 2016-01-07  98.7 100.   96.4  96.4 81094400     89.9
##  5 AAPL   Technology 2016-01-08  98.6  99.1  96.8  97.0 70798000     90.4
##  6 AAPL   Technology 2016-01-11  99.0  99.1  97.3  98.5 49739400     91.9
##  7 AAPL   Technology 2016-01-12 101.  101.   98.8 100.  49154200     93.2
##  8 AAPL   Technology 2016-01-13 100.  101.   97.3  97.4 62439600     90.8
##  9 AAPL   Technology 2016-01-14  98.0 100.   95.7  99.5 63170100     92.8
## 10 AAPL   Technology 2016-01-15  96.2  97.7  95.4  97.1 79833900     90.6
## # … with 746 more rows</code></pre>
</div>
<div id="method-2b-use-index-or-exchange" class="section level3">
<h3 class="hasAnchor">
<a href="#method-2b-use-index-or-exchange" class="anchor"></a>Method 2B: Use index or exchange</h3>
<p>Get an index…</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="../reference/tq_index.html">tq_index</a></span>(<span class="st">"DOW"</span>)</a></code></pre></div>
<pre><code>## # A tibble: 30 x 8
##    symbol company    identifier sedol  weight sector  shares_held local_currency
##    &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;chr&gt;         
##  1 AAPL   Apple Inc. 03783310   20462… 0.0814 Inform…     5504653 USD           
##  2 UNH    UnitedHea… 91324P10   29177… 0.0756 Health…     5504653 USD           
##  3 HD     Home Depo… 43707610   24342… 0.0554 Consum…     5504653 USD           
##  4 GS     Goldman S… 38141G10   24079… 0.0520 Financ…     5504653 USD           
##  5 V      Visa Inc.… 92826C83   B2PZN… 0.0511 Inform…     5504653 USD           
##  6 MCD    McDonald'… 58013510   25507… 0.0501 Consum…     5504653 USD           
##  7 MSFT   Microsoft… 59491810   25881… 0.0455 Inform…     5504653 USD           
##  8 MMM    3M Company 88579Y10   25957… 0.0440 Indust…     5504653 USD           
##  9 BA     Boeing Co… 09702310   21086… 0.0435 Indust…     5504653 USD           
## 10 JNJ    Johnson &amp;… 47816010   24758… 0.0427 Health…     5504653 USD           
## # … with 20 more rows</code></pre>
<p>…or, get an exchange.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/tq_index.html">tq_exchange</a></span>(<span class="st">"NYSE"</span>)</a></code></pre></div>
<p>Send the index or exchange to <code>tq_get</code>. <em>Important Note: This can take several minutes depending on the size of the index or exchange, which is why only the first three stocks are evaluated in the vignette.</em></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="../reference/tq_index.html">tq_index</a></span>(<span class="st">"DOW"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/tq_get.html">tq_get</a></span>(<span class="dt">get =</span> <span class="st">"stock.prices"</span>)</a></code></pre></div>
<pre><code>## # A tibble: 7,704 x 15
##    symbol company identifier sedol weight sector shares_held local_currency
##    &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;         
##  1 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
##  2 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
##  3 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
##  4 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
##  5 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
##  6 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
##  7 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
##  8 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
##  9 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
## 10 AAPL   Apple … 03783310   2046… 0.0814 Infor…     5504653 USD           
## # … with 7,694 more rows, and 7 more variables: date &lt;date&gt;, open &lt;dbl&gt;,
## #   high &lt;dbl&gt;, low &lt;dbl&gt;, close &lt;dbl&gt;, volume &lt;dbl&gt;, adjusted &lt;dbl&gt;</code></pre>
<p>You can use any applicable “getter” to get data for <strong>every stock in an index or an exchange</strong>! This includes: “stock.prices”, “key.ratios”, “key.stats”, and more.</p>
</div>
</div>
</div>
<div id="scaling-the-mutation-of-financial-data" class="section level1">
<h1 class="hasAnchor">
<a href="#scaling-the-mutation-of-financial-data" class="anchor"></a>2.0 Scaling the Mutation of Financial Data</h1>
<p>Once you get the data, you typically want to do something with it. You can easily do this at scale. Let’s get the yearly returns for multiple stocks using <code>tq_transmute</code>. First, get the prices. We’ll use the <code>FANG</code> data set, but you typically will use <code>tq_get</code> to retrieve data in “tibble” format.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">FANG</a></code></pre></div>
<pre><code>## # A tibble: 4,032 x 8
##    symbol date        open  high   low close    volume adjusted
##    &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 FB     2013-01-02  27.4  28.2  27.4  28    69846400     28  
##  2 FB     2013-01-03  27.9  28.5  27.6  27.8  63140600     27.8
##  3 FB     2013-01-04  28.0  28.9  27.8  28.8  72715400     28.8
##  4 FB     2013-01-07  28.7  29.8  28.6  29.4  83781800     29.4
##  5 FB     2013-01-08  29.5  29.6  28.9  29.1  45871300     29.1
##  6 FB     2013-01-09  29.7  30.6  29.5  30.6 104787700     30.6
##  7 FB     2013-01-10  30.6  31.5  30.3  31.3  95316400     31.3
##  8 FB     2013-01-11  31.3  32.0  31.1  31.7  89598000     31.7
##  9 FB     2013-01-14  32.1  32.2  30.6  31.0  98892800     31.0
## 10 FB     2013-01-15  30.6  31.7  29.9  30.1 173242600     30.1
## # … with 4,022 more rows</code></pre>
<p>Second, use <code>group_by</code> to group by stock symbol. Third, apply the mutation. We can do this in one easy workflow. The <code>periodReturns</code> function is applied to each group of stock prices, and a new data frame was returned with the annual returns in the correct periodicity.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">FANG_returns_yearly &lt;-<span class="st"> </span>FANG <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(symbol) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/tq_mutate.html">tq_transmute</a></span>(<span class="dt">select     =</span> adjusted, </a>
<a class="sourceLine" id="cb15-4" data-line-number="4">                 <span class="dt">mutate_fun =</span> periodReturn, </a>
<a class="sourceLine" id="cb15-5" data-line-number="5">                 <span class="dt">period     =</span> <span class="st">"yearly"</span>, </a>
<a class="sourceLine" id="cb15-6" data-line-number="6">                 <span class="dt">col_rename =</span> <span class="st">"yearly.returns"</span>) </a></code></pre></div>
<p>Last, we can visualize the returns.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">FANG_returns_yearly <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">year</span>(date), <span class="dt">y =</span> yearly.returns, <span class="dt">fill =</span> symbol)) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">"dodge"</span>, <span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"FANG: Annual Returns"</span>, </a>
<a class="sourceLine" id="cb16-5" data-line-number="5">         <span class="dt">subtitle =</span> <span class="st">"Mutating at scale is quick and easy!"</span>,</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">         <span class="dt">y =</span> <span class="st">"Returns"</span>, <span class="dt">x =</span> <span class="st">""</span>, <span class="dt">color =</span> <span class="st">""</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="st">    </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="st">    </span><span class="kw"><a href="../reference/theme_tq.html">theme_tq</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="st">    </span><span class="kw"><a href="../reference/scale_manual.html">scale_fill_tq</a></span>()</a></code></pre></div>
<p><img src="TQ03-scaling-and-modeling-with-tidyquant_files/figure-html/unnamed-chunk-11-1.png" width="95%" style="display: block; margin: auto;"></p>
<p><a class="anchor" id="purrr-function-mapping"></a></p>
</div>
<div id="modeling-financial-data-using-purrr" class="section level1">
<h1 class="hasAnchor">
<a href="#modeling-financial-data-using-purrr" class="anchor"></a>3.0 Modeling Financial Data using purrr</h1>
<p>Eventually you will want to begin modeling (or more generally applying functions) at scale! One of the <strong>best</strong> features of the <code>tidyverse</code> is the ability to map functions to nested tibbles using <code>purrr</code>. From the Many Models chapter of “<a href="http://r4ds.had.co.nz/">R for Data Science</a>”, we can apply the same modeling workflow to financial analysis. Using a two step workflow:</p>
<ol style="list-style-type: decimal">
<li>Model a single stock</li>
<li>Scale to many stocks</li>
</ol>
<p>Let’s go through an example to illustrate.</p>
<div id="example-applying-a-regression-model-to-detect-a-positive-trend" class="section level2">
<h2 class="hasAnchor">
<a href="#example-applying-a-regression-model-to-detect-a-positive-trend" class="anchor"></a>Example: Applying a Regression Model to Detect a Positive Trend</h2>
<p>In this example, we’ll use a simple linear model to identify the trend in annual returns to determine if the stock returns are decreasing or increasing over time.</p>
<div id="analyze-a-single-stock" class="section level3">
<h3 class="hasAnchor">
<a href="#analyze-a-single-stock" class="anchor"></a>Analyze a Single Stock</h3>
<p>First, let’s collect stock data with <code><a href="../reference/tq_get.html">tq_get()</a></code></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">AAPL &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tq_get.html">tq_get</a></span>(<span class="st">"AAPL"</span>, <span class="dt">from =</span> <span class="st">"2007-01-01"</span>, <span class="dt">to =</span> <span class="st">"2016-12-31"</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">AAPL</a></code></pre></div>
<pre><code>## # A tibble: 2,518 x 8
##    symbol date        open  high   low close    volume adjusted
##    &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 AAPL   2007-01-03  12.3  12.4  11.7  12.0 309579900     10.4
##  2 AAPL   2007-01-04  12.0  12.3  12.0  12.2 211815100     10.6
##  3 AAPL   2007-01-05  12.3  12.3  12.1  12.2 208685400     10.5
##  4 AAPL   2007-01-08  12.3  12.4  12.2  12.2 199276700     10.6
##  5 AAPL   2007-01-09  12.4  13.3  12.2  13.2 837324600     11.5
##  6 AAPL   2007-01-10  13.5  14.0  13.4  13.9 738220000     12.0
##  7 AAPL   2007-01-11  13.7  13.8  13.6  13.7 360063200     11.9
##  8 AAPL   2007-01-12  13.5  13.6  13.3  13.5 328172600     11.7
##  9 AAPL   2007-01-16  13.7  13.9  13.6  13.9 311019100     12.0
## 10 AAPL   2007-01-17  13.9  13.9  13.5  13.6 411565000     11.8
## # … with 2,508 more rows</code></pre>
<p>Next, come up with a function to help us collect annual log returns. The function below mutates the stock prices to period returns using <code><a href="../reference/tq_mutate.html">tq_transmute()</a></code>. We add the <code>type = "log"</code> and <code>period = "monthly"</code> arguments to ensure we retrieve a tibble of monthly log returns. Last, we take the mean of the monthly returns to get MMLR.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">get_annual_returns &lt;-<span class="st"> </span><span class="cf">function</span>(stock.returns) {</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">    stock.returns <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="st">        </span><span class="kw"><a href="../reference/tq_mutate.html">tq_transmute</a></span>(<span class="dt">select     =</span> adjusted, </a>
<a class="sourceLine" id="cb19-4" data-line-number="4">                     <span class="dt">mutate_fun =</span> periodReturn, </a>
<a class="sourceLine" id="cb19-5" data-line-number="5">                     <span class="dt">type       =</span> <span class="st">"log"</span>, </a>
<a class="sourceLine" id="cb19-6" data-line-number="6">                     <span class="dt">period     =</span> <span class="st">"yearly"</span>)</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">}</a></code></pre></div>
<p>Let’s test <code>get_annual_returns</code> out. We now have the annual log returns over the past ten years.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">AAPL_annual_log_returns &lt;-<span class="st"> </span><span class="kw">get_annual_returns</span>(AAPL)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">AAPL_annual_log_returns</a></code></pre></div>
<pre><code>## # A tibble: 10 x 2
##    date       yearly.returns
##    &lt;date&gt;              &lt;dbl&gt;
##  1 2007-12-31         0.860 
##  2 2008-12-31        -0.842 
##  3 2009-12-31         0.904 
##  4 2010-12-31         0.426 
##  5 2011-12-30         0.228 
##  6 2012-12-31         0.282 
##  7 2013-12-31         0.0776
##  8 2014-12-31         0.341 
##  9 2015-12-31        -0.0306
## 10 2016-12-30         0.118</code></pre>
<p>Let’s visualize to identify trends. We can see from the linear trend line that AAPL’s stock returns are declining.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">AAPL_annual_log_returns <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">year</span>(date), <span class="dt">y =</span> yearly.returns)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="kw"><a href="../reference/palette_tq.html">palette_light</a></span>()[[<span class="dv">1</span>]]) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">color =</span> <span class="kw"><a href="../reference/palette_tq.html">palette_light</a></span>()[[<span class="dv">3</span>]]) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="kw"><a href="../reference/palette_tq.html">palette_light</a></span>()[[<span class="dv">3</span>]]) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"lm"</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"AAPL: Visualizing Trends in Annual Returns"</span>,</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">         <span class="dt">x =</span> <span class="st">""</span>, <span class="dt">y =</span> <span class="st">"Annual Returns"</span>, <span class="dt">color =</span> <span class="st">""</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="st">    </span><span class="kw"><a href="../reference/theme_tq.html">theme_tq</a></span>()</a></code></pre></div>
<p><img src="TQ03-scaling-and-modeling-with-tidyquant_files/figure-html/unnamed-chunk-15-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>Now, we can get the linear model using the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function. However, there is one problem: the output is not “tidy”.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">mod &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(yearly.returns <span class="op">~</span><span class="st"> </span><span class="kw">year</span>(date), <span class="dt">data =</span> AAPL_annual_log_returns)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">mod</a></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = yearly.returns ~ year(date), data = AAPL_annual_log_returns)
## 
## Coefficients:
## (Intercept)   year(date)  
##    58.86282     -0.02915</code></pre>
<p>We can utilize the <code>broom</code> package to get “tidy” data from the model. There’s three primary functions:</p>
<ol style="list-style-type: decimal">
<li>
<code>augment</code>: adds columns to the original data such as predictions, residuals and cluster assignments</li>
<li>
<code>glance</code>: provides a one-row summary of model-level statistics</li>
<li>
<code>tidy</code>: summarizes a model’s statistical findings such as coefficients of a regression</li>
</ol>
<p>We’ll use <code>tidy</code> to retrieve the model coefficients.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(broom)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/pkg/broom/man/reexports.html">tidy</a></span>(mod)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   term        estimate std.error statistic p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1 (Intercept)  58.9     113.         0.520   0.617
## 2 year(date)   -0.0291    0.0562    -0.518   0.618</code></pre>
<p>Adding to our workflow, we have the following:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">get_model &lt;-<span class="st"> </span><span class="cf">function</span>(stock_data) {</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">    annual_returns &lt;-<span class="st"> </span><span class="kw">get_annual_returns</span>(stock_data)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">    mod &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(yearly.returns <span class="op">~</span><span class="st"> </span><span class="kw">year</span>(date), <span class="dt">data =</span> annual_returns)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">    <span class="kw"><a href="https://rdrr.io/pkg/broom/man/reexports.html">tidy</a></span>(mod)</a>
<a class="sourceLine" id="cb27-5" data-line-number="5">}</a></code></pre></div>
<p>Testing it out on a single stock. We can see that the “term” that contains the direction of the trend (the slope) is “year(date)”. The interpetation is that as year increases one unit, the annual returns decrease by 3%.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw">get_model</span>(AAPL)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   term        estimate std.error statistic p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1 (Intercept)  58.9     113.         0.520   0.617
## 2 year(date)   -0.0291    0.0562    -0.518   0.618</code></pre>
<p>Now that we have identified the trend direction, it looks like we are ready to scale.</p>
</div>
<div id="scale-to-many-stocks" class="section level3">
<h3 class="hasAnchor">
<a href="#scale-to-many-stocks" class="anchor"></a>Scale to Many Stocks</h3>
<p>Once the analysis for one stock is done scale to many stocks is simple. For brevity, we’ll randomly sample ten stocks from the S&amp;P500 with a call to <code><a href="https://dplyr.tidyverse.org/reference/sample.html">dplyr::sample_n()</a></code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">stocks_tbl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tq_index.html">tq_index</a></span>(<span class="st">"SP500"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-3" data-line-number="3"><span class="st">    </span><span class="kw">sample_n</span>(<span class="dv">5</span>) </a>
<a class="sourceLine" id="cb30-4" data-line-number="4">stocks_tbl</a></code></pre></div>
<pre><code>## # A tibble: 5 x 8
##   symbol company    identifier sedol  weight sector   shares_held local_currency
##   &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;         
## 1 UNM    Unum Group 91529Y10   2433… 1.31e-4 Financi…     2370517 USD           
## 2 NEM    Newmont C… 65163910   2636… 1.68e-3 Materia…     9284024 USD           
## 3 GPC    Genuine P… 37246010   2367… 5.21e-4 Consume…     1651961 USD           
## 4 IEX    IDEX Corp… 45167R10   2456… 4.37e-4 Industr…      849925 USD           
## 5 ZION   Zions Ban… 98970110   2989… 2.29e-4 Financi…     1940089 USD</code></pre>
<p>We can now apply our analysis function to the stocks using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code> and <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map</a></code>. The <code>mutate()</code> function adds a column to our tibble, and the <code>map()</code> function maps our custom <code>get_model</code> function to our tibble of stocks using the <code>symbol</code> column. The <code><a href="https://tidyr.tidyverse.org/reference/nest.html">tidyr::unnest</a></code> function unrolls the nested data frame so all of the model statistics are accessable in the top data frame level. The <code>filter</code>, <code>arrange</code> and <code>select</code> steps just manipulate the data frame to isolate and arrange the data for our viewing.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">stocks_model_stats &lt;-<span class="st"> </span>stocks_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="st">    </span><span class="kw">select</span>(symbol, company) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/tq_get.html">tq_get</a></span>(<span class="dt">from =</span> <span class="st">"2007-01-01"</span>, <span class="dt">to =</span> <span class="st">"2016-12-31"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-4" data-line-number="4"><span class="st">    </span></a>
<a class="sourceLine" id="cb32-5" data-line-number="5"><span class="st">    </span><span class="co"># Nest </span></a>
<a class="sourceLine" id="cb32-6" data-line-number="6"><span class="st">    </span><span class="kw">group_by</span>(symbol, company) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-7" data-line-number="7"><span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-8" data-line-number="8"><span class="st">    </span></a>
<a class="sourceLine" id="cb32-9" data-line-number="9"><span class="st">    </span><span class="co"># Apply the get_model() function to the new "nested" data column</span></a>
<a class="sourceLine" id="cb32-10" data-line-number="10"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="kw">map</span>(data, get_model)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-11" data-line-number="11"><span class="st">    </span></a>
<a class="sourceLine" id="cb32-12" data-line-number="12"><span class="st">    </span><span class="co"># Unnest and collect slope</span></a>
<a class="sourceLine" id="cb32-13" data-line-number="13"><span class="st">    </span><span class="kw">unnest</span>(model) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-14" data-line-number="14"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(term <span class="op">==</span><span class="st"> "year(date)"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-15" data-line-number="15"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(estimate)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-16" data-line-number="16"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>term)</a>
<a class="sourceLine" id="cb32-17" data-line-number="17"></a>
<a class="sourceLine" id="cb32-18" data-line-number="18">stocks_model_stats</a></code></pre></div>
<pre><code>## # A tibble: 5 x 7
## # Groups:   symbol, company [5]
##   symbol company             data           estimate std.error statistic p.value
##   &lt;chr&gt;  &lt;chr&gt;               &lt;list&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1 ZION   Zions Bancorporati… &lt;tibble [2,51…  0.0963     0.0437     2.21   0.0585
## 2 UNM    Unum Group          &lt;tibble [2,51…  0.0219     0.0248     0.883  0.403 
## 3 IEX    IDEX Corporation    &lt;tibble [2,51…  0.0176     0.0264     0.665  0.525 
## 4 GPC    Genuine Parts Comp… &lt;tibble [2,51…  0.0112     0.0211     0.529  0.611 
## 5 NEM    Newmont Corporation &lt;tibble [2,51…  0.00570    0.0404     0.141  0.891</code></pre>
<p>We’re done! We now have the coefficient of the linear regression that tracks the direction of the trend line. We can easily extend this type of analysis to larger lists or stock indexes. For example, the entire S&amp;P500 could be analyzed removing the <code>sample_n()</code> following the call to <code><a href="../reference/tq_index.html">tq_index("SP500")</a></code>.</p>
</div>
</div>
</div>
<div id="error-handling-when-scaling" class="section level1">
<h1 class="hasAnchor">
<a href="#error-handling-when-scaling" class="anchor"></a>4.0 Error Handling when Scaling</h1>
<p>Eventually you will run into a stock index, stock symbol, FRED data code, etc that cannot be retrieved. Possible reasons are:</p>
<ul>
<li>An index becomes out of date</li>
<li>A company goes private</li>
<li>A stock ticker symbol changes</li>
<li>Yahoo / FRED just doesn’t like your stock symbol / FRED code</li>
</ul>
<p>This becomes painful when scaling if the functions return errors. So, the <code><a href="../reference/tq_get.html">tq_get()</a></code> function is designed to handle errors <em>gracefully</em>. What this means is an <code>NA</code> value is returned when an error is generated along with a <em>gentle error warning</em>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="kw"><a href="../reference/tq_get.html">tq_get</a></span>(<span class="st">"XYZ"</span>, <span class="st">"stock.prices"</span>)</a></code></pre></div>
<pre><code>## [1] NA</code></pre>
<div id="pros-and-cons-to-built-in-error-handling" class="section level2">
<h2 class="hasAnchor">
<a href="#pros-and-cons-to-built-in-error-handling" class="anchor"></a>Pros and Cons to Built-In Error-Handling</h2>
<p>There are pros and cons to this approach that you may not agree with, but I believe helps in the long run. Just be aware of what happens:</p>
<ul>
<li><p><strong>Pros</strong>: Long running scripts are not interrupted because of one error</p></li>
<li><p><strong>Cons</strong>: Errors can be inadvertently handled or flow downstream if the users does not read the warnings</p></li>
</ul>
</div>
<div id="bad-apples-fail-gracefully-tq_get" class="section level2">
<h2 class="hasAnchor">
<a href="#bad-apples-fail-gracefully-tq_get" class="anchor"></a>Bad Apples Fail Gracefully, tq_get</h2>
<p>Let’s see an example when using <code><a href="../reference/tq_get.html">tq_get()</a></code> to get the stock prices for a long list of stocks with one <code>BAD APPLE</code>. The argument <code>complete_cases</code> comes in handy. The default is <code>TRUE</code>, which removes “bad apples” so future analysis have complete cases to compute on. Note that a gentle warning stating that an error occurred and was dealt with by removing the rows from the results.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AAPL"</span>, <span class="st">"GOOG"</span>, <span class="st">"BAD APPLE"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/tq_get.html">tq_get</a></span>(<span class="dt">get =</span> <span class="st">"stock.prices"</span>, <span class="dt">complete_cases =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## Warning: x = 'BAD APPLE', get = 'stock.prices': Error in getSymbols.yahoo(Symbols = "BAD APPLE", env = &lt;environment&gt;, : Unable to import "BAD APPLE".
## BAD APPLE download failed after two attempts. Error message:
## HTTP error 400.
##  Removing BAD APPLE.</code></pre>
<pre><code>## # A tibble: 5,136 x 8
##    symbol date        open  high   low close    volume adjusted
##    &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 AAPL   2010-01-04  30.5  30.6  30.3  30.6 123432400     26.5
##  2 AAPL   2010-01-05  30.7  30.8  30.5  30.6 150476200     26.6
##  3 AAPL   2010-01-06  30.6  30.7  30.1  30.1 138040000     26.2
##  4 AAPL   2010-01-07  30.2  30.3  29.9  30.1 119282800     26.1
##  5 AAPL   2010-01-08  30.0  30.3  29.9  30.3 111902700     26.3
##  6 AAPL   2010-01-11  30.4  30.4  29.8  30.0 115557400     26.1
##  7 AAPL   2010-01-12  29.9  30.0  29.5  29.7 148614900     25.8
##  8 AAPL   2010-01-13  29.7  30.1  29.2  30.1 151473000     26.1
##  9 AAPL   2010-01-14  30.0  30.1  29.9  29.9 108223500     26.0
## 10 AAPL   2010-01-15  30.1  30.2  29.4  29.4 148516900     25.5
## # … with 5,126 more rows</code></pre>
<p>Now switching <code>complete_cases = FALSE</code> will retain any errors as <code>NA</code> values in a nested data frame. Notice that the error message and output change. The error message now states that the <code>NA</code> values exist in the output and the return is a “nested” data structure.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AAPL"</span>, <span class="st">"GOOG"</span>, <span class="st">"BAD APPLE"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/tq_get.html">tq_get</a></span>(<span class="dt">get =</span> <span class="st">"stock.prices"</span>, <span class="dt">complete_cases =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## Warning: x = 'BAD APPLE', get = 'stock.prices': Error in getSymbols.yahoo(Symbols = "BAD APPLE", env = &lt;environment&gt;, : Unable to import "BAD APPLE".
## BAD APPLE download failed after two attempts. Error message:
## HTTP error 400.</code></pre>
<pre><code>## # A tibble: 5,137 x 9
##    symbol date        open  high   low close    volume adjusted stock.prices
##    &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;lgl&gt;       
##  1 AAPL   2010-01-04  30.5  30.6  30.3  30.6 123432400     26.5 NA          
##  2 AAPL   2010-01-05  30.7  30.8  30.5  30.6 150476200     26.6 NA          
##  3 AAPL   2010-01-06  30.6  30.7  30.1  30.1 138040000     26.2 NA          
##  4 AAPL   2010-01-07  30.2  30.3  29.9  30.1 119282800     26.1 NA          
##  5 AAPL   2010-01-08  30.0  30.3  29.9  30.3 111902700     26.3 NA          
##  6 AAPL   2010-01-11  30.4  30.4  29.8  30.0 115557400     26.1 NA          
##  7 AAPL   2010-01-12  29.9  30.0  29.5  29.7 148614900     25.8 NA          
##  8 AAPL   2010-01-13  29.7  30.1  29.2  30.1 151473000     26.1 NA          
##  9 AAPL   2010-01-14  30.0  30.1  29.9  29.9 108223500     26.0 NA          
## 10 AAPL   2010-01-15  30.1  30.2  29.4  29.4 148516900     25.5 NA          
## # … with 5,127 more rows</code></pre>
<p>In both cases, the prudent user will review the warnings to determine what happened and whether or not this is acceptable. In the <code>complete_cases = FALSE</code> example, if the user attempts to perform downstream computations at scale, the computations will likely fail grinding the analysis to a hault. But, the advantage is that the user will more easily be able to filter to the problem childs to determine what happened and decide whether this is acceptable or not.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#prerequisites">Prerequisites</a></li>
      <li>
<a href="#scaling-the-getting-of-financial-data">1.0 Scaling the Getting of Financial Data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#method-1-map-a-character-vector-with-multiple-stock-symbols">Method 1: Map a character vector with multiple stock symbols</a></li>
      <li><a href="#method-2-map-a-tibble-with-stocks-in-first-column">Method 2: Map a tibble with stocks in first column</a></li>
      </ul>
</li>
      <li><a href="#scaling-the-mutation-of-financial-data">2.0 Scaling the Mutation of Financial Data</a></li>
      <li>
<a href="#modeling-financial-data-using-purrr">3.0 Modeling Financial Data using purrr</a><ul class="nav nav-pills nav-stacked">
<li><a href="#example-applying-a-regression-model-to-detect-a-positive-trend">Example: Applying a Regression Model to Detect a Positive Trend</a></li>
      </ul>
</li>
      <li>
<a href="#error-handling-when-scaling">4.0 Error Handling when Scaling</a><ul class="nav nav-pills nav-stacked">
<li><a href="#pros-and-cons-to-built-in-error-handling">Pros and Cons to Built-In Error-Handling</a></li>
      <li><a href="#bad-apples-fail-gracefully-tq_get">Bad Apples Fail Gracefully, tq_get</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matt Dancho, Davis Vaughan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

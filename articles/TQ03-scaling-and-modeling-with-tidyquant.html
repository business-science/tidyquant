<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Scaling and Modeling with tidyquant • tidyquant</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Scaling and Modeling with tidyquant">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-20GDZ5LL77"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-20GDZ5LL77');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidyquant</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.11.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/TQ00-introduction-to-tidyquant.html">Start</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="../articles/TQ00-introduction-to-tidyquant.html">Introduction to Tidyquant</a></li>
    <li><a class="dropdown-item" href="../articles/TQ01-core-functions-in-tidyquant.html">Core Functions in Tidyquant</a></li>
    <li><a class="dropdown-item" href="../articles/TQ02-quant-integrations-in-tidyquant.html">Quant Integrations in Tidyquant</a></li>
    <li><a class="dropdown-item" href="../articles/TQ03-scaling-and-modeling-with-tidyquant.html">Scaling and Modeling with Tidyquant</a></li>
    <li><a class="dropdown-item" href="../articles/TQ04-charting-with-tidyquant.html">Charting with Tidyquant</a></li>
    <li><a class="dropdown-item" href="../articles/TQ05-performance-analysis-with-tidyquant.html">Performance Analysis with Tidyquant</a></li>
    <li><a class="dropdown-item" href="../articles/TQ06-excel-in-r.html">Excel Integrations in R</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-api" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">API</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-api">
<li><a class="dropdown-item" href="../reference/index.html">API Functions</a></li>
    <li><a class="dropdown-item" href="../news/index.html">News</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/business-science/tidyquant"><span class="fa fab fa-github"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/business-science/tidyquant" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Scaling and Modeling with tidyquant</h1>
                        <h4 data-toc-skip class="author">Matt
Dancho</h4>
            
            <h4 data-toc-skip class="date">2025-03-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/business-science/tidyquant/blob/master/vignettes/TQ03-scaling-and-modeling-with-tidyquant.Rmd" class="external-link"><code>vignettes/TQ03-scaling-and-modeling-with-tidyquant.Rmd</code></a></small>
      <div class="d-none name"><code>TQ03-scaling-and-modeling-with-tidyquant.Rmd</code></div>
    </div>

    
    
<blockquote>
<p>Designed for the data science workflow of the
<code>tidyverse</code></p>
</blockquote>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The greatest benefit to <code>tidyquant</code> is the ability to
apply the data science workflow to easily model and scale your financial
analysis as described in <a href="https://r4ds.hadley.nz/" class="external-link"><em>R for
Data Science</em></a>. Scaling is the process of creating an analysis
for one asset and then extending it to multiple groups. This idea of
scaling is incredibly useful to financial analysts because typically one
wants to compare many assets to make informed decisions. Fortunately,
the <code>tidyquant</code> package integrates with the
<code>tidyverse</code> making scaling super simple!</p>
<p>All <code>tidyquant</code> functions return data in the
<code>tibble</code> (tidy data frame) format, which allows for
interaction within the <code>tidyverse</code>. This means we can:</p>
<ul>
<li>Seamlessly scale data retrieval and mutations</li>
<li>Use the pipe (<code>%&gt;%</code>) for chaining operations</li>
<li>Use <code>dplyr</code> and <code>tidyr</code>: <code>select</code>,
<code>filter</code>, <code>group_by</code>,
<code>nest</code>/<code>unnest</code>,
<code>spread</code>/<code>gather</code>, etc</li>
<li>Use <code>purrr</code>: mapping functions with
<code>map()</code>
</li>
<li>Model financial analysis using the data science workflow in <a href="https://r4ds.hadley.nz/" class="external-link"><em>R for Data Science</em></a>
</li>
</ul>
<p>We’ll go through some useful techniques for getting and manipulating
groups of data.</p>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>Load the <code>tidyquant</code> package to get started.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Loads tidyquant, xts, quantmod, TTR, and PerformanceAnalytics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://business-science.github.io/tidyquant/">tidyquant</a></span><span class="op">)</span>  </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="scaling-the-getting-of-financial-data">1.0 Scaling the Getting of Financial Data<a class="anchor" aria-label="anchor" href="#scaling-the-getting-of-financial-data"></a>
</h2>
<p>A very basic example is retrieving the stock prices for multiple
stocks. There are three primary ways to do this:</p>
<div class="section level3">
<h3 id="method-1-map-a-character-vector-with-multiple-stock-symbols">Method 1: Map a character vector with multiple stock symbols<a class="anchor" aria-label="anchor" href="#method-1-map-a-character-vector-with-multiple-stock-symbols"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AAPL"</span>, <span class="st">"GOOG"</span>, <span class="st">"META"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/tq_get.html">tq_get</a></span><span class="op">(</span>get <span class="op">=</span> <span class="st">"stock.prices"</span>, from <span class="op">=</span> <span class="st">"2016-01-01"</span>, to <span class="op">=</span> <span class="st">"2017-01-01"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 756 × 8</span></span></span>
<span><span class="co">##    symbol date        open  high   low close    volume adjusted</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> AAPL   2016-01-04  25.7  26.3  25.5  26.3 270<span style="text-decoration: underline;">597</span>600     23.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> AAPL   2016-01-05  26.4  26.5  25.6  25.7 223<span style="text-decoration: underline;">164</span>000     23.2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> AAPL   2016-01-06  25.1  25.6  25.0  25.2 273<span style="text-decoration: underline;">829</span>600     22.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> AAPL   2016-01-07  24.7  25.0  24.1  24.1 324<span style="text-decoration: underline;">377</span>600     21.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> AAPL   2016-01-08  24.6  24.8  24.2  24.2 283<span style="text-decoration: underline;">192</span>000     21.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> AAPL   2016-01-11  24.7  24.8  24.3  24.6 198<span style="text-decoration: underline;">957</span>600     22.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> AAPL   2016-01-12  25.1  25.2  24.7  25.0 196<span style="text-decoration: underline;">616</span>800     22.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> AAPL   2016-01-13  25.1  25.3  24.3  24.3 249<span style="text-decoration: underline;">758</span>400     22.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> AAPL   2016-01-14  24.5  25.1  23.9  24.9 252<span style="text-decoration: underline;">680</span>400     22.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> AAPL   2016-01-15  24.0  24.4  23.8  24.3 319<span style="text-decoration: underline;">335</span>600     22.0</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 746 more rows</span></span></span></code></pre>
<p>The output is a single level tibble with all or the stock prices in
one tibble. The auto-generated column name is “symbol”, which can be
preemptively renamed by giving the vector a name
(e.g. <code>stocks &lt;- c("AAPL", "GOOG", "META")</code>) and then
piping to <code>tq_get</code>.</p>
</div>
<div class="section level3">
<h3 id="method-2-map-a-tibble-with-stocks-in-first-column">Method 2: Map a tibble with stocks in first column<a class="anchor" aria-label="anchor" href="#method-2-map-a-tibble-with-stocks-in-first-column"></a>
</h3>
<p>First, get a stock list in data frame format either by making the
tibble or retrieving from <code>tq_index</code> /
<code>tq_exchange</code>. The stock symbols must be in the first
column.</p>
<div class="section level4">
<h4 id="method-2a-make-a-tibble">Method 2A: Make a tibble<a class="anchor" aria-label="anchor" href="#method-2a-make-a-tibble"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stock_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>stocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AAPL"</span>, <span class="st">"JPM"</span>, <span class="st">"CVX"</span><span class="op">)</span>,</span>
<span>                     industry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Technology"</span>, <span class="st">"Financial"</span>, <span class="st">"Energy"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">stock_list</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">##   stocks industry  </span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> AAPL   Technology</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> JPM    Financial </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> CVX    Energy</span></span></code></pre>
<p>Second, send the stock list to <code>tq_get</code>. Notice how the
symbol and industry columns are automatically expanded the length of the
stock prices.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stock_list</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/tq_get.html">tq_get</a></span><span class="op">(</span>get <span class="op">=</span> <span class="st">"stock.prices"</span>, from <span class="op">=</span> <span class="st">"2016-01-01"</span>, to <span class="op">=</span> <span class="st">"2017-01-01"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 756 × 9</span></span></span>
<span><span class="co">##    stocks industry   date        open  high   low close    volume adjusted</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> AAPL   Technology 2016-01-04  25.7  26.3  25.5  26.3 270<span style="text-decoration: underline;">597</span>600     23.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> AAPL   Technology 2016-01-05  26.4  26.5  25.6  25.7 223<span style="text-decoration: underline;">164</span>000     23.2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> AAPL   Technology 2016-01-06  25.1  25.6  25.0  25.2 273<span style="text-decoration: underline;">829</span>600     22.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> AAPL   Technology 2016-01-07  24.7  25.0  24.1  24.1 324<span style="text-decoration: underline;">377</span>600     21.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> AAPL   Technology 2016-01-08  24.6  24.8  24.2  24.2 283<span style="text-decoration: underline;">192</span>000     21.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> AAPL   Technology 2016-01-11  24.7  24.8  24.3  24.6 198<span style="text-decoration: underline;">957</span>600     22.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> AAPL   Technology 2016-01-12  25.1  25.2  24.7  25.0 196<span style="text-decoration: underline;">616</span>800     22.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> AAPL   Technology 2016-01-13  25.1  25.3  24.3  24.3 249<span style="text-decoration: underline;">758</span>400     22.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> AAPL   Technology 2016-01-14  24.5  25.1  23.9  24.9 252<span style="text-decoration: underline;">680</span>400     22.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> AAPL   Technology 2016-01-15  24.0  24.4  23.8  24.3 319<span style="text-decoration: underline;">335</span>600     22.0</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 746 more rows</span></span></span></code></pre>
</div>
<div class="section level4">
<h4 id="method-2b-use-index-or-exchange">Method 2B: Use index or exchange<a class="anchor" aria-label="anchor" href="#method-2b-use-index-or-exchange"></a>
</h4>
<p>Get an index…</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tq_index.html">tq_index</a></span><span class="op">(</span><span class="st">"DOW"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 31 × 8</span></span></span>
<span><span class="co">##    symbol company      identifier sedol weight sector shares_held local_currency</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> UNH    UNITEDHEALT… 91324P102  2917… 0.066<span style="text-decoration: underline;">6</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> MSFT   MICROSOFT C… 594918104  2588… 0.055<span style="text-decoration: underline;">8</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> HD     HOME DEPOT … 437076102  2434… 0.055<span style="text-decoration: underline;">5</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> V      VISA INC CL… 92826C839  B2PZ… 0.050<span style="text-decoration: underline;">6</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> SHW    SHERWIN WIL… 824348106  2804… 0.050<span style="text-decoration: underline;">5</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> CAT    CATERPILLAR… 149123101  2180… 0.048<span style="text-decoration: underline;">3</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> MCD    MCDONALD S … 580135101  2550… 0.044<span style="text-decoration: underline;">1</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> AMGN   AMGEN INC    031162100  2023… 0.043<span style="text-decoration: underline;">5</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> CRM    SALESFORCE … 79466L302  2310… 0.041<span style="text-decoration: underline;">9</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 21 more rows</span></span></span></code></pre>
<p>…or, get an exchange.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tq_index.html">tq_exchange</a></span><span class="op">(</span><span class="st">"NYSE"</span><span class="op">)</span></span></code></pre></div>
<p>Send the index or exchange to <code>tq_get</code>. <em>Important
Note: This can take several minutes depending on the size of the index
or exchange, which is why only the first three stocks are evaluated in
the vignette.</em></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tq_index.html">tq_index</a></span><span class="op">(</span><span class="st">"DOW"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/tq_get.html">tq_get</a></span><span class="op">(</span>get <span class="op">=</span> <span class="st">"stock.prices"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 7,665 × 15</span></span></span>
<span><span class="co">##    symbol company      identifier sedol weight sector shares_held local_currency</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> GS     GOLDMAN SAC… 38141G104  2407… 0.086<span style="text-decoration: underline;">0</span> -          5<span style="text-decoration: underline;">458</span>984 USD           </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 7,655 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 7 more variables: date &lt;date&gt;, open &lt;dbl&gt;, high &lt;dbl&gt;, low &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   close &lt;dbl&gt;, volume &lt;dbl&gt;, adjusted &lt;dbl&gt;</span></span></span></code></pre>
<p>You can use any applicable “getter” to get data for <strong>every
stock in an index or an exchange</strong>! This includes:
“stock.prices”, “key.ratios”, “key.stats”, and more.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="scaling-the-mutation-of-financial-data">2.0 Scaling the Mutation of Financial Data<a class="anchor" aria-label="anchor" href="#scaling-the-mutation-of-financial-data"></a>
</h2>
<p>Once you get the data, you typically want to do something with it.
You can easily do this at scale. Let’s get the yearly returns for
multiple stocks using <code>tq_transmute</code>. First, get the prices.
We’ll use the <code>FANG</code> data set, but you typically will use
<code>tq_get</code> to retrieve data in “tibble” format.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FANG</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 4,032 × 8</span></span></span>
<span><span class="co">##    symbol date        open  high   low close    volume adjusted</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> META   2013-01-02  27.4  28.2  27.4  28    69<span style="text-decoration: underline;">846</span>400     28  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> META   2013-01-03  27.9  28.5  27.6  27.8  63<span style="text-decoration: underline;">140</span>600     27.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> META   2013-01-04  28.0  28.9  27.8  28.8  72<span style="text-decoration: underline;">715</span>400     28.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> META   2013-01-07  28.7  29.8  28.6  29.4  83<span style="text-decoration: underline;">781</span>800     29.4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> META   2013-01-08  29.5  29.6  28.9  29.1  45<span style="text-decoration: underline;">871</span>300     29.1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> META   2013-01-09  29.7  30.6  29.5  30.6 104<span style="text-decoration: underline;">787</span>700     30.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> META   2013-01-10  30.6  31.5  30.3  31.3  95<span style="text-decoration: underline;">316</span>400     31.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> META   2013-01-11  31.3  32.0  31.1  31.7  89<span style="text-decoration: underline;">598</span>000     31.7</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> META   2013-01-14  32.1  32.2  30.6  31.0  98<span style="text-decoration: underline;">892</span>800     31.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> META   2013-01-15  30.6  31.7  29.9  30.1 173<span style="text-decoration: underline;">242</span>600     30.1</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 4,022 more rows</span></span></span></code></pre>
<p>Second, use <code>group_by</code> to group by stock symbol. Third,
apply the mutation. We can do this in one easy workflow. The
<code>periodReturn</code> function is applied to each group of stock
prices, and a new data frame was returned with the annual returns in the
correct periodicity.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FANG_returns_yearly</span> <span class="op">&lt;-</span> <span class="va">FANG</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">symbol</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/tq_mutate.html">tq_transmute</a></span><span class="op">(</span>select     <span class="op">=</span> <span class="va">adjusted</span>, </span>
<span>                 mutate_fun <span class="op">=</span> <span class="va">periodReturn</span>, </span>
<span>                 period     <span class="op">=</span> <span class="st">"yearly"</span>, </span>
<span>                 col_rename <span class="op">=</span> <span class="st">"yearly.returns"</span><span class="op">)</span> </span></code></pre></div>
<p>Last, we can visualize the returns.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FANG_returns_yearly</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">yearly.returns</span>, fill <span class="op">=</span> <span class="va">symbol</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span>, stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"FANG: Annual Returns"</span>, </span>
<span>         subtitle <span class="op">=</span> <span class="st">"Mutating at scale is quick and easy!"</span>,</span>
<span>         y <span class="op">=</span> <span class="st">"Returns"</span>, x <span class="op">=</span> <span class="st">""</span>, color <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/theme_tq.html">theme_tq</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/scale_manual.html">scale_fill_tq</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="TQ03-scaling-and-modeling-with-tidyquant_files/figure-html/unnamed-chunk-11-1.png" width="95%" style="display: block; margin: auto;"></p>
<p><a class="anchor" id="purrr-function-mapping"></a></p>
</div>
<div class="section level2">
<h2 id="modeling-financial-data-using-purrr">3.0 Modeling Financial Data using purrr<a class="anchor" aria-label="anchor" href="#modeling-financial-data-using-purrr"></a>
</h2>
<p>Eventually you will want to begin modeling (or more generally
applying functions) at scale! One of the <strong>best</strong> features
of the <code>tidyverse</code> is the ability to map functions to nested
tibbles using <code>purrr</code>. From the Many Models chapter of “<a href="https://r4ds.hadley.nz/" class="external-link">R for Data Science</a>”, we can apply the
same modeling workflow to financial analysis. Using a two step
workflow:</p>
<ol style="list-style-type: decimal">
<li>Model a single stock</li>
<li>Scale to many stocks</li>
</ol>
<p>Let’s go through an example to illustrate.</p>
<div class="section level3">
<h3 id="example-applying-a-regression-model-to-detect-a-positive-trend">Example: Applying a Regression Model to Detect a Positive Trend<a class="anchor" aria-label="anchor" href="#example-applying-a-regression-model-to-detect-a-positive-trend"></a>
</h3>
<p>In this example, we’ll use a simple linear model to identify the
trend in annual returns to determine if the stock returns are decreasing
or increasing over time.</p>
<div class="section level4">
<h4 id="analyze-a-single-stock">Analyze a Single Stock<a class="anchor" aria-label="anchor" href="#analyze-a-single-stock"></a>
</h4>
<p>First, let’s collect stock data with <code><a href="../reference/tq_get.html">tq_get()</a></code></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AAPL</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tq_get.html">tq_get</a></span><span class="op">(</span><span class="st">"AAPL"</span>, from <span class="op">=</span> <span class="st">"2007-01-01"</span>, to <span class="op">=</span> <span class="st">"2016-12-31"</span><span class="op">)</span></span>
<span><span class="va">AAPL</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2,518 × 8</span></span></span>
<span><span class="co">##    symbol date        open  high   low close     volume adjusted</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> AAPL   2007-01-03  3.08  3.09  2.92  2.99 <span style="text-decoration: underline;">1</span>238<span style="text-decoration: underline;">319</span>600     2.52</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> AAPL   2007-01-04  3.00  3.07  2.99  3.06  847<span style="text-decoration: underline;">260</span>400     2.58</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> AAPL   2007-01-05  3.06  3.08  3.01  3.04  834<span style="text-decoration: underline;">741</span>600     2.56</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> AAPL   2007-01-08  3.07  3.09  3.05  3.05  797<span style="text-decoration: underline;">106</span>800     2.57</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> AAPL   2007-01-09  3.09  3.32  3.04  3.31 <span style="text-decoration: underline;">3</span>349<span style="text-decoration: underline;">298</span>400     2.79</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> AAPL   2007-01-10  3.38  3.49  3.34  3.46 <span style="text-decoration: underline;">2</span>952<span style="text-decoration: underline;">880</span>000     2.92</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> AAPL   2007-01-11  3.43  3.46  3.40  3.42 <span style="text-decoration: underline;">1</span>440<span style="text-decoration: underline;">252</span>800     2.88</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> AAPL   2007-01-12  3.38  3.39  3.33  3.38 <span style="text-decoration: underline;">1</span>312<span style="text-decoration: underline;">690</span>400     2.85</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> AAPL   2007-01-16  3.42  3.47  3.41  3.47 <span style="text-decoration: underline;">1</span>244<span style="text-decoration: underline;">076</span>400     2.92</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> AAPL   2007-01-17  3.48  3.49  3.39  3.39 <span style="text-decoration: underline;">1</span>646<span style="text-decoration: underline;">260</span>000     2.86</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,508 more rows</span></span></span></code></pre>
<p>Next, come up with a function to help us collect annual log returns.
The function below mutates the stock prices to period returns using
<code><a href="../reference/tq_mutate.html">tq_transmute()</a></code>. We add the <code>type = "log"</code> and
<code>period = "monthly"</code> arguments to ensure we retrieve a tibble
of monthly log returns. Last, we take the mean of the monthly returns to
get MMLR.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_annual_returns</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">stock.returns</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">stock.returns</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="../reference/tq_mutate.html">tq_transmute</a></span><span class="op">(</span>select     <span class="op">=</span> <span class="va">adjusted</span>, </span>
<span>                     mutate_fun <span class="op">=</span> <span class="va">periodReturn</span>, </span>
<span>                     type       <span class="op">=</span> <span class="st">"log"</span>, </span>
<span>                     period     <span class="op">=</span> <span class="st">"yearly"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s test <code>get_annual_returns</code> out. We now have the
annual log returns over the past ten years.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AAPL_annual_log_returns</span> <span class="op">&lt;-</span> <span class="fu">get_annual_returns</span><span class="op">(</span><span class="va">AAPL</span><span class="op">)</span></span>
<span><span class="va">AAPL_annual_log_returns</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 2</span></span></span>
<span><span class="co">##    date       yearly.returns</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 2007-12-31         0.860 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 2008-12-31        -<span style="color: #BB0000;">0.842</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 2009-12-31         0.904 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 2010-12-31         0.426 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 2011-12-30         0.228 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 2012-12-31         0.282 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 2013-12-31         0.077<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 2014-12-31         0.341 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 2015-12-31        -<span style="color: #BB0000;">0.030</span><span style="color: #BB0000; text-decoration: underline;">6</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 2016-12-30         0.118</span></span></code></pre>
<p>Let’s visualize to identify trends. We can see from the linear trend
line that AAPL’s stock returns are declining.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AAPL_annual_log_returns</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">yearly.returns</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="fu"><a href="../reference/palette_tq.html">palette_light</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="fu"><a href="../reference/palette_tq.html">palette_light</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="fu"><a href="../reference/palette_tq.html">palette_light</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"AAPL: Visualizing Trends in Annual Returns"</span>,</span>
<span>         x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">"Annual Returns"</span>, color <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/theme_tq.html">theme_tq</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="TQ03-scaling-and-modeling-with-tidyquant_files/figure-html/unnamed-chunk-15-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>Now, we can get the linear model using the <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>
function. However, there is one problem: the output is not “tidy”.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">yearly.returns</span> <span class="op">~</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">AAPL_annual_log_returns</span><span class="op">)</span></span>
<span><span class="va">mod</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lm(formula = yearly.returns ~ year(date), data = AAPL_annual_log_returns)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">## (Intercept)   year(date)  </span></span>
<span><span class="co">##    58.86277     -0.02915</span></span></code></pre>
<p>We can utilize the <code>broom</code> package to get “tidy” data from
the model. There’s three primary functions:</p>
<ol style="list-style-type: decimal">
<li>
<code>augment</code>: adds columns to the original data such as
predictions, residuals and cluster assignments</li>
<li>
<code>glance</code>: provides a one-row summary of model-level
statistics</li>
<li>
<code>tidy</code>: summarizes a model’s statistical findings such as
coefficients of a regression</li>
</ol>
<p>We’ll use <code>tidy</code> to retrieve the model coefficients.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">##   term        estimate std.error statistic p.value</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> (Intercept)  58.9     113.         0.520   0.617</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> year(date)   -<span style="color: #BB0000;">0.029</span><span style="color: #BB0000; text-decoration: underline;">1</span>    0.056<span style="text-decoration: underline;">2</span>    -<span style="color: #BB0000;">0.518</span>   0.618</span></span></code></pre>
<p>Adding to our workflow, we have the following:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">stock_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">annual_returns</span> <span class="op">&lt;-</span> <span class="fu">get_annual_returns</span><span class="op">(</span><span class="va">stock_data</span><span class="op">)</span></span>
<span>    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">yearly.returns</span> <span class="op">~</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">annual_returns</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Testing it out on a single stock. We can see that the “term” that
contains the direction of the trend (the slope) is “year(date)”. The
interpretation is that as year increases one unit, the annual returns
decrease by 3%.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_model</span><span class="op">(</span><span class="va">AAPL</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">##   term        estimate std.error statistic p.value</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> (Intercept)  58.9     113.         0.520   0.617</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> year(date)   -<span style="color: #BB0000;">0.029</span><span style="color: #BB0000; text-decoration: underline;">1</span>    0.056<span style="text-decoration: underline;">2</span>    -<span style="color: #BB0000;">0.518</span>   0.618</span></span></code></pre>
<p>Now that we have identified the trend direction, it looks like we are
ready to scale.</p>
</div>
<div class="section level4">
<h4 id="scale-to-many-stocks">Scale to Many Stocks<a class="anchor" aria-label="anchor" href="#scale-to-many-stocks"></a>
</h4>
<p>Once the analysis for one stock is done scale to many stocks is
simple. For brevity, we’ll randomly sample ten stocks from the
S&amp;P500 with a call to <code><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">dplyr::sample_n()</a></code>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">stocks_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tq_index.html">tq_index</a></span><span class="op">(</span><span class="st">"SP500"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> </span>
<span><span class="va">stocks_tbl</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 5 × 8</span></span></span>
<span><span class="co">##   symbol company      identifier sedol  weight sector shares_held local_currency</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> MKTX   MARKETAXESS… 57060D108  B03Q… 1.46<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> -           <span style="text-decoration: underline;">474</span>488 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> CMG    CHIPOTLE ME… 169656105  B0X7… 1.45<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> -         17<span style="text-decoration: underline;">098</span>901 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> TDY    TELEDYNE TE… 879360105  2503… 4.69<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> -           <span style="text-decoration: underline;">584</span>455 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> PTC    PTC INC      69370C100  B95N… 3.93<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> -          1<span style="text-decoration: underline;">507</span>726 USD           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> MRNA   MODERNA INC  60770K107  BGSX… 2.12<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> -          4<span style="text-decoration: underline;">254</span>577 USD</span></span></code></pre>
<p>We can now apply our analysis function to the stocks using
<code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">dplyr::mutate()</a></code> and <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code>. The
<code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code> function adds a column to our tibble, and the
<code>map()</code> function maps our custom <code>get_model</code>
function to our tibble of stocks using the <code>symbol</code> column.
The <code><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">tidyr::unnest()</a></code> function unrolls the nested data frame
so all of the model statistics are accessible in the top data frame
level. The <code>filter</code>, <code>arrange</code> and
<code>select</code> steps just manipulate the data frame to isolate and
arrange the data for our viewing.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stocks_model_stats</span> <span class="op">&lt;-</span> <span class="va">stocks_tbl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">symbol</span>, <span class="va">company</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/tq_get.html">tq_get</a></span><span class="op">(</span>from <span class="op">=</span> <span class="st">"2007-01-01"</span>, to <span class="op">=</span> <span class="st">"2016-12-31"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># Nest </span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">symbol</span>, <span class="va">company</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">nest</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># Apply the get_model() function to the new "nested" data column</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="va">get_model</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># Unnest and collect slope</span></span>
<span>    <span class="fu">unnest</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"year(date)"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">term</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stocks_model_stats</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 4 × 7</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   symbol, company [4]</span></span></span>
<span><span class="co">##   symbol company                   data     estimate std.error statistic p.value</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> MKTX   MARKETAXESS HOLDINGS INC  <span style="color: #949494;">&lt;tibble&gt;</span>   0.045<span style="text-decoration: underline;">5</span>    0.034<span style="text-decoration: underline;">4</span>     1.32    0.223</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> PTC    PTC INC                   <span style="color: #949494;">&lt;tibble&gt;</span>   0.026<span style="text-decoration: underline;">2</span>    0.028<span style="text-decoration: underline;">1</span>     0.932   0.379</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> TDY    TELEDYNE TECHNOLOGIES INC <span style="color: #949494;">&lt;tibble&gt;</span>   0.014<span style="text-decoration: underline;">3</span>    0.023<span style="text-decoration: underline;">2</span>     0.617   0.554</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> CMG    CHIPOTLE MEXICAN GRILL I… <span style="color: #949494;">&lt;tibble&gt;</span>  -<span style="color: #BB0000;">0.055</span><span style="color: #BB0000; text-decoration: underline;">9</span>    0.064<span style="text-decoration: underline;">7</span>    -<span style="color: #BB0000;">0.863</span>   0.413</span></span></code></pre>
<p>We’re done! We now have the coefficient of the linear regression that
tracks the direction of the trend line. We can easily extend this type
of analysis to larger lists or stock indexes. For example, the entire
S&amp;P500 could be analyzed removing the <code><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n()</a></code>
following the call to <code>tq_index("SP500")</code>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="error-handling-when-scaling">4.0 Error Handling when Scaling<a class="anchor" aria-label="anchor" href="#error-handling-when-scaling"></a>
</h2>
<p>Eventually you will run into a stock index, stock symbol, FRED data
code, etc that cannot be retrieved. Possible reasons are:</p>
<ul>
<li>An index becomes out of date</li>
<li>A company goes private</li>
<li>A stock ticker symbol changes</li>
<li>Yahoo / FRED just doesn’t like your stock symbol / FRED code</li>
</ul>
<p>This becomes painful when scaling if the functions return errors. So,
the <code><a href="../reference/tq_get.html">tq_get()</a></code> function is designed to handle errors
<em>gracefully</em>. What this means is an <code>NA</code> value is
returned when an error is generated along with a <em>gentle error
warning</em>.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tq_get.html">tq_get</a></span><span class="op">(</span><span class="st">"XYZ"</span>, <span class="st">"stock.prices"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2,332 × 8</span></span></span>
<span><span class="co">##    symbol date        open  high   low close   volume adjusted</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> XYZ    2015-11-19  11.2  14.8   9    13.1 47<span style="text-decoration: underline;">466</span>100     13.1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> XYZ    2015-11-20  13.9  14.1  12.5  12.9 16<span style="text-decoration: underline;">550</span>300     12.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> XYZ    2015-11-23  13    13.1  12.1  12.1  5<span style="text-decoration: underline;">172</span>200     12.1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> XYZ    2015-11-24  12    12.2  11.5  12.0  4<span style="text-decoration: underline;">714</span>700     12.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> XYZ    2015-11-25  12.1  12.4  11.9  11.9  3<span style="text-decoration: underline;">583</span>400     11.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> XYZ    2015-11-27  12.1  12.3  11.9  12.1   <span style="text-decoration: underline;">942</span>300     12.1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> XYZ    2015-11-30  12.3  12.4  11.9  12.0  1<span style="text-decoration: underline;">997</span>100     12.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> XYZ    2015-12-01  12.1  12.2  11.9  11.9  1<span style="text-decoration: underline;">256</span>100     11.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> XYZ    2015-12-02  12.0  12.2  11.9  11.9  1<span style="text-decoration: underline;">708</span>100     11.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> XYZ    2015-12-03  12.0  12.2  11.9  11.9  1<span style="text-decoration: underline;">431</span>400     11.9</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,322 more rows</span></span></span></code></pre>
<div class="section level3">
<h3 id="pros-and-cons-to-built-in-error-handling">Pros and Cons to Built-In Error-Handling<a class="anchor" aria-label="anchor" href="#pros-and-cons-to-built-in-error-handling"></a>
</h3>
<p>There are pros and cons to this approach that you may not agree with,
but I believe helps in the long run. Just be aware of what happens:</p>
<ul>
<li><p><strong>Pros</strong>: Long running scripts are not interrupted
because of one error</p></li>
<li><p><strong>Cons</strong>: Errors can be inadvertently handled or
flow downstream if the user does not read the warnings</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="bad-apples-fail-gracefully-tq_get">Bad Apples Fail Gracefully, tq_get<a class="anchor" aria-label="anchor" href="#bad-apples-fail-gracefully-tq_get"></a>
</h3>
<p>Let’s see an example when using <code><a href="../reference/tq_get.html">tq_get()</a></code> to get the
stock prices for a long list of stocks with one <code>BAD APPLE</code>.
The argument <code>complete_cases</code> comes in handy. The default is
<code>TRUE</code>, which removes “bad apples” so future analysis have
complete cases to compute on. Note that a gentle warning stating that an
error occurred and was dealt with by removing the rows from the
results.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AAPL"</span>, <span class="st">"GOOG"</span>, <span class="st">"BAD APPLE"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/tq_get.html">tq_get</a></span><span class="op">(</span>get <span class="op">=</span> <span class="st">"stock.prices"</span>, complete_cases <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There was 1 warning in `dplyr::mutate()`.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> In argument: `data.. = purrr::map(...)`.</span></span>
<span><span class="co">## Caused by warning:</span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> x = 'BAD APPLE', get = 'stock.prices': Error in getSymbols.yahoo(Symbols = "BAD APPLE", env = &lt;environment&gt;, : Unable to import "BAD APPLE".</span></span>
<span><span class="co">## cannot open the connection</span></span>
<span><span class="co">##  Removing BAD APPLE.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 5,110 × 8</span></span></span>
<span><span class="co">##    symbol date        open  high   low close    volume adjusted</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> AAPL   2015-01-02  27.8  27.9  26.8  27.3 212<span style="text-decoration: underline;">818</span>400     24.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> AAPL   2015-01-05  27.1  27.2  26.4  26.6 257<span style="text-decoration: underline;">142</span>000     23.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> AAPL   2015-01-06  26.6  26.9  26.2  26.6 263<span style="text-decoration: underline;">188</span>400     23.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> AAPL   2015-01-07  26.8  27.0  26.7  26.9 160<span style="text-decoration: underline;">423</span>600     24.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> AAPL   2015-01-08  27.3  28.0  27.2  28.0 237<span style="text-decoration: underline;">458</span>000     24.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> AAPL   2015-01-09  28.2  28.3  27.6  28.0 214<span style="text-decoration: underline;">798</span>000     24.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> AAPL   2015-01-12  28.1  28.2  27.2  27.3 198<span style="text-decoration: underline;">603</span>200     24.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> AAPL   2015-01-13  27.9  28.2  27.2  27.6 268<span style="text-decoration: underline;">367</span>600     24.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> AAPL   2015-01-14  27.3  27.6  27.1  27.5 195<span style="text-decoration: underline;">826</span>400     24.4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> AAPL   2015-01-15  27.5  27.5  26.7  26.7 240<span style="text-decoration: underline;">056</span>000     23.8</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 5,100 more rows</span></span></span></code></pre>
<p>Now switching <code>complete_cases = FALSE</code> will retain any
errors as <code>NA</code> values in a nested data frame. Notice that the
error message and output change. The error message now states that the
<code>NA</code> values exist in the output and the return is a “nested”
data structure.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AAPL"</span>, <span class="st">"GOOG"</span>, <span class="st">"BAD APPLE"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/tq_get.html">tq_get</a></span><span class="op">(</span>get <span class="op">=</span> <span class="st">"stock.prices"</span>, complete_cases <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There was 1 warning in `dplyr::mutate()`.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> In argument: `data.. = purrr::map(...)`.</span></span>
<span><span class="co">## Caused by warning:</span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> x = 'BAD APPLE', get = 'stock.prices': Error in getSymbols.yahoo(Symbols = "BAD APPLE", env = &lt;environment&gt;, : Unable to import "BAD APPLE".</span></span>
<span><span class="co">## cannot open the connection</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 5,111 × 8</span></span></span>
<span><span class="co">##    symbol date        open  high   low close    volume adjusted</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> AAPL   2015-01-02  27.8  27.9  26.8  27.3 212<span style="text-decoration: underline;">818</span>400     24.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> AAPL   2015-01-05  27.1  27.2  26.4  26.6 257<span style="text-decoration: underline;">142</span>000     23.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> AAPL   2015-01-06  26.6  26.9  26.2  26.6 263<span style="text-decoration: underline;">188</span>400     23.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> AAPL   2015-01-07  26.8  27.0  26.7  26.9 160<span style="text-decoration: underline;">423</span>600     24.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> AAPL   2015-01-08  27.3  28.0  27.2  28.0 237<span style="text-decoration: underline;">458</span>000     24.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> AAPL   2015-01-09  28.2  28.3  27.6  28.0 214<span style="text-decoration: underline;">798</span>000     24.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> AAPL   2015-01-12  28.1  28.2  27.2  27.3 198<span style="text-decoration: underline;">603</span>200     24.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> AAPL   2015-01-13  27.9  28.2  27.2  27.6 268<span style="text-decoration: underline;">367</span>600     24.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> AAPL   2015-01-14  27.3  27.6  27.1  27.5 195<span style="text-decoration: underline;">826</span>400     24.4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> AAPL   2015-01-15  27.5  27.5  26.7  26.7 240<span style="text-decoration: underline;">056</span>000     23.8</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 5,101 more rows</span></span></span></code></pre>
<p>In both cases, the prudent user will review the warnings to determine
what happened and whether or not this is acceptable. In the
<code>complete_cases = FALSE</code> example, if the user attempts to
perform downstream computations at scale, the computations will likely
fail grinding the analysis to a halt. But, the advantage is that the
user will more easily be able to filter to the problem root to determine
what happened and decide whether this is acceptable or not.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matt Dancho, Davis Vaughan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
